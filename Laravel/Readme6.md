# Registration and Authentication

## Breeze

Install Laravel Breeze:

```terminal
composer require laravel/breeze
```

The installation will generate authentication controllers, Blade templates and routes.

Be careful, the installation erases the routes and replaces them with library ones. You will have to transfer them manually. Also `composer dump-autoload` will not work.

You may need to add a stub `resources/views/welcome.blade.php` so that the installer does not crash if you use TWIG.

## Building the frontend

```
npm install && npm run dev
```

Starts the Vite dev server for assets. The PHP server is started separately: `php artisan serve`.

Open `/register` and `/login` — the pages will display templates generated by Breeze.

- GET routes for `/login` and `/register` return views via web routes:
- `routes/web.php` renders `view('auth.login')` and `view('auth.register')` (guest middleware).
- POST logic remains in Breeze controllers in `routes/auth.php`.

Let's set up a redirect to the main page after authorization (`route('home')`), and not to `/dashboard`. [AuthenticatedSessionController](./app/Http/Controllers/Auth/AuthenticatedSessionController.php).

```php
return redirect()->intended(route('home', absolute: false));
```

## UsersController controller

- Command: `php artisan make:controller UsersController`
- File: `app/Http/Controllers/UsersController.php`
- Implementation:

```php
public function index(Request $request)
{
$this->authorize('view-any', User::class);
$users = User::select(['id', 'name', 'email', 'is_admin'])->orderBy('id')->get();
return response()->json($users);
}
```

## Route `/users`

In `routes/web.php`:

```php
Route::middleware('auth')->get('/users', [UsersController::class, 'index'])->name('users.index');
```

Access only for authenticated, plus access policy is in effect.

## Migrations: roles and bookings

Changed and added new migrations for roles and bookings.

## Access policy `UserPolicy`

```
php artisan make:policy UserPolicy --model=User
```

```php
public function viewAny(User $user): bool
{
return (bool) $user->is_admin;
}
```

## Registering a policy in `AuthServiceProvider`

[AuthServiceProvider.php](./laravel-project/app/Providers/AuthServiceProvider.php)

```php
protected $policies = [
User::class => UserPolicy::class,
];
```

## Authorization in UsersController

Added a policy call to the `index` method:

```php
$this->authorize('view-any', User::class);
```

An unauthenticated or non-admin user will receive 403 Forbidden.

## Reference

- Breeze authentication routes live in `routes/auth.php`. Web routes are in `routes/web.php`.
- GET `/login` and `/register` — guest middleware and render via `view(...)`.
- After login, redirect to the main page (`home`).
- Project pages: `/`, `/books`, `/reserved`, `/my/reserved`, `/db-introspect`, `/logs`, `/news/*`.
- For the frontend, keep `npm run dev` in a separate terminal, PHP — `php artisan serve` in another.
